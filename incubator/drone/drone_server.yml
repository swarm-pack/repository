service_name: drone_server
docker_image: drone/drone
docker_registry: docker.io
docker_compose_template: default
entrypoint:
  - /run/1Day/docker_secrets_expand.sh
  - /bin/drone-server
#ports:
#  - target: 9000
#    published: 9000
#    protocol: tcp
#    mode: host
environments:
  nonprod:
    docker_tag: 0.8-alpine
    environment:
      DRONE_OPEN: "true"
      DRONE_ORGS: "1Day"
      DRONE_ADMIN: kevb,jp.saballegue,vudknguyen,slytherin9090
      # NOTE: Gitlab application callback URL should be https://drone.1day.host/login
      DRONE_GITLAB: "true"
      DRONE_GITLAB_SERVER: "https://gitlab.com"
      DRONE_NETWORK: "app_net"
      DRONE_GITLAB_PRIVATE_MODE: "true"
      #Drone 0.8
      # Note: port 8000
      DRONE_HOST: "https://drone.1day.host"
      DRONE_SECRET: "DOCKER-SECRET->drone_secret"
      DRONE_GITLAB_CLIENT: "DOCKER-SECRET->drone_gitlab_client"
      DRONE_GITLAB_SECRET: "DOCKER-SECRET->drone_gitlab_client_secret"
      #Drone 0.9
      # Note: port 80
      #DRONE_RPC_SECRET: "1daytempsecret881"
      #DRONE_SERVER_PROTO="https"
      #DRONE_SERVER_HOST="drone.1day.host"
      #DRONE_SERVER_PORT="443"
      #DRONE_HOST: "drone.1day.host"
      #DRONE_GITLAB_CLIENT_ID: "{{ drone_gitlab_client_id }}"
      #DRONE_GITLAB_CLIENT_SECRET: "{{ drone_gitlab_client_secret }}"

    secrets:
      - drone_secret
      - drone_gitlab_client
      - drone_gitlab_client_secret
      - source: "docker_secrets_expand_sh"
        target: "/run/1Day/docker_secrets_expand.sh"
        mode: "0555"
    deploy:
      labels:
        - "traefik.docker.network=app_net"
        - "traefik.port=8000"
        - "traefik.frontend.rule=Host:drone.1day.host"
        - "traefik.backend.loadbalancer.stickiness=true"
      endpoint_mode: dnsrr
      placement:
        constraints:
          - "node.hostname==swarm-nonprod-m1"
    volumes:
      - drone_database:/var/lib/drone/
    volume_definitions:
      drone_database:
